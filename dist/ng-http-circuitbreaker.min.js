(function(){"use strict";function a(){var a={circuits:[]};this.circuit=function(b){if(!b)throw{source:"ngHttpCircuitBreakerConfig",message:"Circuit Config required"};if(!b.endPointRegEx)throw{source:"ngHttpCircuitBreakerConfig",message:"Circuit Endpoint Regular Expression required"};if(!b.endPointRegEx.test)throw{source:"ngHttpCircuitBreakerConfig",message:"Circuit Parameter endPointRegEx must be a regular expression"};for(var d=0;d<a.circuits.length;d++)if(a.circuits[d].endPointRegEx.toString().toUpperCase()===b.endPointRegEx.toString().toUpperCase())throw{source:"ngHttpCircuitBreakerConfig",message:"Duplicate endpoint regular expression found"};if(isNaN(b.failureLimit)&&(b.failureLimit=5),b.failureLimit<=0)throw{source:"ngHttpCircuitBreakerConfig",message:"Invalid failure limit - must be positive, non-zero value"};if(isNaN(b.responseSLA)&&(b.responseSLA=500),b.responseSLA<0)throw{source:"ngHttpCircuitBreakerConfig",message:"Invalid Response SLA - must be non-negative. Set to 0 if you do not want a response sla to be set."};if(isNaN(b.timeUntilHalfOpen)&&(b.timeUntilHalfOpen=5e3),b.timeUntilHalfOpen<=0)throw{source:"ngHttpCircuitBreakerConfig",message:"Invalid Circuit timeUntilHalfOpen - must be a positive non-zero integer value"};if(b.statusCodesToIgnore||(b.statusCodesToIgnore=[401,403,409]),!Array.isArray(b.statusCodesToIgnore))throw{source:"ngHttpCircuitBreakerConfig",message:"Invalid statusCodesToIgnore - expecting array of integer values representing HTTP response codes"};return a.circuits.push({endPointRegEx:b.endPointRegEx,failureLimit:b.failureLimit,responseSLA:b.responseSLA,timeUntilHalfOpen:b.timeUntilHalfOpen,statusCodesToIgnore:b.statusCodesToIgnore,STATE:c,timerSet:!1,failureCount:0}),this},this.$get=function(){return a}}var b=angular.module("ng-http-circuitbreaker",[]),c=0,d=1,e=2;b.provider("ngHttpCircuitBreakerConfig",a),b.factory("ngHttpCircuitBreaker",["ngHttpCircuitBreakerConfig","$q","$timeout","$log",function(a,b,f,g){return{request:function(f){for(var h=0;h<a.circuits.length;h++)if(a.circuits[h].endPointRegEx.test(f.url)){g.info("Circuit Breaker protecting "+f.url);var i=a.circuits[h];if(f.cktbkr={circuit:h},i.STATE===c||i.STATE===d){a.circuits[h].responseSLA>0&&(f.timeout=a.circuits[h].responseSLA),i.STATE===d&&(g.warn("Circuit breaker is HALF-OPEN - allowing request for "+f.url+" through"),i.STATE=e);break}if(i.STATE===e)return g.error("Circuit breaker for "+f.url+" is OPEN - short circuiting request"),b.reject(f)}return f||b.when(f)},response:function(d){if(d.config.cktbkr){var f=a.circuits[d.config.cktbkr.circuit];f.STATE===e?(g.info("Circuit breaker detected successful call to "+d.config.url+" - closing circuit"),f.STATE=c,f.failureCount=0):f.failureCount>0&&(f.failureCount-=1)}return d||b.when(d)},responseError:function(c){if(c.config&&c.config.cktbkr){var h=a.circuits[c.config.cktbkr.circuit];if(-1!==h.statusCodesToIgnore.indexOf(c.status))return g.info("Circuit breaker ignoring status code "+c.status+" for circuit "+c.config.url),b.reject(c);h.failureCount+=1,h.failureCount>=h.failureLimit&&(g.error("Circuit breaker limit reached for circuit "+h.endPointRegEx.toString()+" with failed request to "+c.config.url+" with code "+c.status),h.STATE=e,h.timerSet||f(function(){g.warn("Circuit breaker switching to HALF-OPEN status for circuit "+h.endPointRegEx.toString()),h.STATE=d,h.timerSet=!1},h.timeUntilHalfOpen),h.timerSet=!0)}return b.reject(c)}}}])}).call(this);